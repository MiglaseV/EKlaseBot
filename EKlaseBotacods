from flask import Flask, render_template, request, session, redirect, url_for, flash
import requests
from bs4 import BeautifulSoup
import random

app = Flask(__name__)
app.secret_key = "change-this-to-something-long-and-random"  # change this!

# Latvian motivational quotes
motivations = [
    "Tu esi spƒìjƒ´gs uz daudz vairƒÅk, nekƒÅ domƒÅ! üí™",
    "Katra atrisinƒÅta uzdevuma padara tevi par supervaroni ü¶∏‚Äç‚ôÇÔ∏è",
    "Nevis \"gr≈´ti\", bet \"vƒìl neesmu iemƒÅcƒ´jies\" üî•",
    "Tava nƒÅkotne pateiks paldies par ≈°odienu! üåü",
    "Tu neesi slinks ‚Äì tu esi uzlƒÅdƒì≈°anƒÅs re≈æƒ´mƒÅ üòé",
    "Pat Einsteinam bija sliktas dienas. TurpinƒÅm! üöÄ",
    "MƒÅcƒ´ties = ieguldƒ´t sevƒ´. Tu esi labƒÅkais ieguldƒ´jums! üí∞"
]

hints = [
    "Tell me what YOU already know about this topic. Let‚Äôs start there! üß†",
    "What do you think the first step could be?",
    "Try writing your own answer ‚Äì I‚Äôll tell you if you‚Äôre on the right track üòâ",
    "Think: what did the teacher want you to learn with this task?",
    "I‚Äôll give you a hint, but only after you guess at least one step! üî•"
]

class EKlase:
    def __init__(self):
        self.session = requests.Session()

    def login(self, username, password):
        url = "https://my.e-klase.lv/Account/Login"
        r = self.session.get(url)
        soup = BeautifulSoup(r.text, 'html.parser')
        token = soup.find("input", {"name": "__RequestVerificationToken"})["value"]

        data = {
            "UserName": username,
            "Password": password,
            "__RequestVerificationToken": token
        }
        resp = self.session.post(url, data=data, allow_redirects=True)
        return "mana lapa" in resp.url.lower() or resp.status_code == 200

    def get_homework(self):
        try:
            r = self.session.get("https://my.e-klase.lv/Homework")
            soup = BeautifulSoup(r.text, "html.parser")
            tasks = []
            for row in soup.select(".homework-row")[:10]:
                date = row.select_one(".date").text.strip() if row.select_one(".date") else "Soon"
                subject = row.select_one(".subject").text.strip()
                task = row.select_one(".description").text.strip()
                tasks.append({"date": date, "subject": subject, "task": task})
            return tasks if tasks else [{"date": "Today", "subject": "Free day!", "task": "You earned a rest!"}]
        except:
            return [{"date": "Error", "subject": "Could not load", "task": "Check internet or try again later"}]

eklase = EKlase()

@app.route("/", methods=["GET", "POST"])
def index():
    if "logged_in" not in session:
        return redirect(url_for("login"))

    if request.method == "POST":
        message = request.form.get("message", "").lower()

        # Motivation
        if any(word in message for word in ["motivation", "motiv", "iedvesma"]):
            flash(random.choice(motivations), "motivation")

        # Smart help
        elif any(word in message for word in ["help", "how", "palƒ´dz", "kƒÅ", "solve", "don‚Äôt know"]):
            flash(random.choice(hints), "hint")

        # Reward
        elif any(word in message for word in ["done", "paldies", "izdevƒÅs", "finished", "thanks"]):
            session["points"] = session.get("points", 0) + 10
            if session["points"] >= session.get("level", 1) * 100:
                session["level"] = session.get("level", 1) + 1
                flash(f"LEVEL UP! You are now level {session['level']}! üéâ", "levelup")
            else:
                flash(f"+10 points! Total: {session['points']}", "success")

        # Refresh homework
        session["homework"] = eklase.get_homework()

    return render_template(
        "index.html",
        homework=session.get("homework", []),
        points=session.get("points", 0),
        level=session.get("level", 1)
    )

@app.route("/login", methods=["GET", "POST"])
def login():
    if request.method == "POST":
        username = request.form["username"]
        password = request.form["password"]
        if eklase.login(username, password):
            session["logged_in"] = True
session["points"] = 50
            session["level"] = 1
            session["homework"] = eklase.get_homework()
            flash("Successfully logged in! +50 starter points üéÅ", "success")
            return redirect("/")
        else:
            flash("Wrong username or password", "error")
    return render_template("login.html")

@app.route("/logout")
def logout():
    session.clear()
    return redirect("/login")

if name == "__main__":
    app.run(debug=True, host="0.0.0.0", port=5000)
